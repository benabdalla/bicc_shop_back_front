<div class="page-content">
  <div class="card">
    <div class="card-body p-4">
      <h5 class="card-title">Ajouter un produit</h5>
      <hr />
      <div class="form-body mt-4">
        <form #_form="ngForm" (submit)="saveProduct(_form.value)">
          <div class="row">
            <div class="col-lg-8">
              <div class="border border-3 p-4 rounded">
                <div class="mb-3">
                  <label for="inputProductTitle" class="form-label"
                    >Nom du produit</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="inputProductTitle"
                    placeholder="Saisir le nom du produit"
                    name="title"
                    ngModel
                  />
                </div>

                <!-- Multiple Images Upload Section -->
                <div class="mb-3">
                  <label for="inputProductImages" class="form-label"
                    >Images du produit</label
                  >

                  <!-- Drag & Drop Area -->
                  <div
                    class="upload-zone"
                    [class.dragover]="isDragOver"
                    (dragover)="onDragOver($event)"
                    (dragleave)="onDragLeave($event)"
                    (drop)="onDrop($event)"
                    (click)="triggerFileInput()"
                    (keydown.enter)="triggerFileInput()"
                    [attr.aria-label]="'Click to upload product images'"
                  >
                    <div class="upload-zone-content">
                      <i
                        class="bi bi-cloud-upload display-4 text-muted mb-3"
                      ></i>
                      <h6 class="text-muted">Glissez-déposez les images ici</h6>
                      <p class="text-muted mb-2">
                        ou
                        <span class="text-primary">cliquez pour parcourir</span>
                      </p>
                      <small class="text-muted">
                        Formats supportés : JPG, PNG, GIF, WebP (Max 5Mo chacun)
                      </small>
                    </div>
                  </div>

                  <!-- No images message -->
                  <div
                    *ngIf="productImages.length === 0 && !uploadingImages"
                    class="mt-2"
                  >
                    <small class="text-muted">
                      <i class="bi bi-info-circle me-1"></i>
                      Aucune image téléchargée pour le moment. Utilisez la zone
                      ci-dessus pour ajouter des images.
                    </small>
                  </div>

                  <input
                    type="file"
                    class="d-none"
                    id="inputProductImages"
                    #fileInput
                    multiple
                    accept="image/*"
                    (change)="onMultipleImagesSelected($event)"
                  />

                  <!-- Upload Progress -->
                  <div *ngIf="uploadingImages" class="upload-progress mt-3">
                    <div class="d-flex align-items-center mb-2">
                      <div class="spinner-border spinner-border-sm me-2"></div>
                      <span class="fw-medium"
                        >Téléchargement de {{ uploadingCount }} sur
                        {{ totalUploadCount }} images...</span
                      >
                    </div>

                    <!-- Individual File Progress -->
                    <div
                      *ngFor="let progress of getUploadProgressArray()"
                      class="progress-item"
                    >
                      <span class="progress-filename">{{
                        progress.filename
                      }}</span>
                      <div class="progress-bar">
                        <div
                          class="progress-fill"
                          [style.width.%]="progress.progress"
                        ></div>
                      </div>
                      <span class="progress-percentage ms-2"
                        >{{ progress.progress }}%</span
                      >
                    </div>
                  </div>

                  <!-- Image Preview Gallery -->
                  <div *ngIf="productImages.length > 0" class="mt-3">
                    <div
                      class="d-flex justify-content-between align-items-center mb-2"
                    >
                      <small class="text-muted"
                        >{{ productImages.length }} image(s) uploaded</small
                      >
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-danger"
                        (click)="clearAllImages()"
                      >
                        <i class="bi bi-trash me-1"></i>
                        Tout supprimer
                      </button>
                    </div>
                    <div class="image-gallery">
                      <div
                        *ngFor="let image of productImages; let i = index"
                        class="image-preview-item"
                        draggable="true"
                        (dragstart)="onImageDragStart($event, i)"
                        (dragover)="onImageDragOver($event)"
                        (drop)="onImageDrop($event, i)"
                      >
                        <div class="image-order-number">{{ i + 1 }}</div>
                        <img
                          [src]="getImageDisplayUrl(image)"
                          alt="Product preview {{ i + 1 }}"
                          class="preview-image"
                        />
                        <button
                          type="button"
                          class="btn btn-sm btn-danger remove-btn"
                          (click)="removeImage(i)"
                          [title]="'Remove image ' + (i + 1)"
                        >
                          <i class="bi bi-x"></i>
                        </button>
                        <div
                          class="drag-handle"
                          title="Glisser pour réorganiser"
                        >
                          <i class="bi bi-grip-vertical"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="inputProductDescription" class="form-label"
                    >Description</label
                  >
                  <textarea
                    class="form-control"
                    id="inputProductDescription"
                    rows="3"
                    name="description"
                    ngModel
                  ></textarea>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="border border-3 p-4 rounded">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="inputRegularPrice" class="form-label"
                      >Prix normal</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="inputRegularPrice"
                      placeholder="00.00"
                      name="regularPrice"
                      ngModel
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="inputSalePrice" class="form-label"
                      >Prix promotionnel</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="inputSalePrice"
                      placeholder="00.00"
                      name="salePrice"
                      [(ngModel)]="defaultSalePrice"
                    />
                  </div>
                  <div class="col-12">
                    <label for="inputProductCategory" class="form-label"
                      >Catégorie du produit</label
                    >
                    <select
                      class="form-select"
                      id="inputProductCategory"
                      name="category"
                      ngModel
                    >
                      <option *ngFor="let c of categories" value="{{ c.id }}">
                        {{ c.title }}
                      </option>
                    </select>
                  </div>
                  <div class="col-12">
                    <label for="inputStockStatus" class="form-label"
                      >Statut du stock</label
                    >
                    <select
                      class="form-select"
                      id="inputStockStatus"
                      name="stockStatus"
                      ngModel
                    >
                      <option value="In Stock">En stock</option>
                      <option value="Out of Stock">Rupture de stock</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <label for="inputStockCount" class="form-label"
                      >Quantité en stock</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="inputStockCount"
                      placeholder="0"
                      name="stockCount"
                      ngModel
                    />
                  </div>

                  <div class="col-12">
                    <div class="d-grid">
                      <button type="submit" class="btn btn-primary">
                        Enregistrer le produit
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!--end row-->
        </form>
      </div>
    </div>
  </div>
</div>
